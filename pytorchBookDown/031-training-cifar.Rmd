
# Training An Image Classifier for CIFAR10 Image Data

This part is from [Training A Classifier](https://pytorch.org/tutorials/beginner/blitz/cifar10_tutorial.html#sphx-glr-beginner-blitz-cifar10-tutorial-py)

## What About Data?

Generally, when you have to deal with image, text, audio or video data, you can use standard python packages that load data into a numpy array. Then you can convert this array into a torch.*Tensor.

- For images, packages such as Pillow, OpenCV are useful
- For audio, packages such as scipy and librosa
- For text, either raw Python or Cython based loading, or NLTK and SpaCy are useful

Specifically for vision, we have created a package called `torchvision`, that has data loaders for common datasets such as Imagenet, CIFAR10, MNIST, etc. and data transformers for images, viz., `torchvision.datasets` and `torch.utils.data.DataLoader`.

This provides a huge convenience and avoids writing boilerplate code.

## CIFAR-10 Dataset

For this tutorial, we will use the CIFAR10 dataset. It has the classes: ‘airplane’, ‘automobile’, ‘bird’, ‘cat’, ‘deer’, ‘dog’, ‘frog’, ‘horse’, ‘ship’, ‘truck’. The images in CIFAR-10 are of size 3x32x32, i.e. 3-channel color images of 32x32 pixels in size.

```{r, echo=FALSE, fig.align='center', fig.cap='Sample images of CIFAR-10 Dataset'}
knitr::include_graphics('data/cifar10.png')
```

The detail on the original source of CIFAR-10 dataset is provided in [The CIFAR-10 dataset](https://www.cs.toronto.edu/~kriz/cifar.html).

- The CIFAR-10 dataset consists of 60000 32x32 colour images in 10 classes, with 6000 images per class. There are 50000 training images and 10000 test images. 

- The dataset is divided into five training batches and one test batch, each with 10000 images. The test batch contains exactly 1000 randomly-selected images from each class. The training batches contain the remaining images in random order, but some training batches may contain more images from one class than another. Between them, the training batches contain exactly 5000 images from each class. 

- The classes are completely mutually exclusive. There is no overlap between automobiles and trucks. "Automobile" includes sedans, SUVs, things of that sort. "Truck" includes only big trucks. Neither includes pickup trucks.

- The best test accuracy was 96.53% (Fractional Max-Pooling by Benjamin Graham, 2015). The history can be found in [Who is the best in CIFAR-10](http://rodrigob.github.io/are_we_there_yet/build/classification_datasets_results.html#43494641522d3130).


## Chapter Plan

We will do the following steps in order:

1. Load and normalize the CIFAR-10 training and test datasets using `torchvision`
1. Define a Convolution Neural Network
1. Define a loss function
1. Train the network on the training data
1. Test the network on the test data


## Load and normalizing the CIFAR-10 dataset for training and test

Using torchvision, it’s extremely easy to load CIFAR-10.

```{python}
import torch
import torchvision
import torchvision.transforms as transforms
```

The output of torchvision datasets are `PILImage` images of range [0, 1]. We transform them to Tensors of normalized range [-1, 1].

```{python}
transform = transforms.Compose(
    [transforms.ToTensor(),
     transforms.Normalize((0.5, 0.5, 0.5), (0.5, 0.5, 0.5))])

trainset = torchvision.datasets.CIFAR10(root='./data', train=True,
                                        download=True, transform=transform)
trainloader = torch.utils.data.DataLoader(trainset, batch_size=4,
                                          shuffle=True)

testset = torchvision.datasets.CIFAR10(root='./data', train=False,
                                       download=True, transform=transform)
testloader = torch.utils.data.DataLoader(testset, batch_size=4,
                                         shuffle=False, num_workers=2)

classes = ('plane', 'car', 'bird', 'cat', 'deer', 'dog', 'frog', 'horse', 'ship', 'truck')
```

* You have a look at the directory named `./data`. It will have several files including `batches.meta` and `test_batch`:
```{python}
import os
print(os.listdir('./data'))
print (os.listdir('./data/cifar-10-batches-py'))
```

Let us show some of the training images, for fun.
```{python}
import matplotlib.pyplot as plt
import numpy as np

# get some random training images
dataiter = iter(trainloader)
images, labels = dataiter.next()
print ('> output of dataiter.next():\n', 
    'images: ', type(images), images.shape, '\n', 'labels: ', type(labels), 'labels={}'.format(labels))

# show images
fig, axes = plt.subplots(1,4)
for i, ax in enumerate(axes):
    npimg = images[i].numpy().transpose((1,2,0)) / 2 + 0.5
    ax.imshow(npimg)
    ax.set_title (classes[labels[i]])
    print ('type(img) = ', type(images[i]), images[i].shape, '-->', npimg.shape)

plt.show()
```

* The mini-batch of images returned by `dataiter.next()` has 4 images.
* Their format is `(channel, width, height)` which is required for `pytorch` operations. However, `plt` expects a numpy array of `(width, height, channel)`. This is why we need `transpose((1,2,0))`.
* Image scaling is required to scale the pixel values to [0,1] range.
* The image's class label is printed on each of the image.




## Define a Convolution Neural Network

```{python}
import torch.nn as nn

class myNet(nn.Module):
    def __init__(self):
        super(myNet, self).__init__()
        self.conv1 = nn.Conv2d(3, 6, 5)
        self.relu1 = nn.ReLU()
        self.pool = nn.MaxPool2d(2, 2)
        self.conv2 = nn.Conv2d(6, 16, 5)
        self.relu2 = nn.ReLU()
        self.fc1 = nn.Linear(16 * 5 * 5, 120)
        self.fc2 = nn.Linear(120, 84)
        self.fc3 = nn.Linear(84, 10)

    def forward(self, x):
        x = self.pool(self.relu1(self.conv1(x)))
        x = self.pool(self.relu2(self.conv2(x)))
        x = x.view(-1, 16 * 5 * 5)
        x = F.relu(self.fc1(x))
        x = F.relu(self.fc2(x))
        x = self.fc3(x)
        return x
#

net = myNet()

print (net)
```

What is this netowrk? What are the modules used in `myNet`? They will be explained at the very late sections. For now, let's just remember that the input is a mini-batch of images of size `4x3x32x32` and the output is an integer number indicating the class label.

## Define a loss function


## Train the network on the training data


## Test the network on the test data


## `torch.nn` modules used in `myNet`
### `Conv2d`: a convolutional Neural Netowrk for 2d image data
### `ReLU`: an activation function
### `MaxPool2d`
### `Linear`


## Conclusion


EOC